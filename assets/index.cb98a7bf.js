var e=Object.defineProperty,t=Object.defineProperties,i=Object.getOwnPropertyDescriptors,o=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,r=(t,i,o)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[i]=o,c=(e,t)=>{for(var i in t||(t={}))n.call(t,i)&&r(e,i,t[i]);if(o)for(var i of o(t))s.call(t,i)&&r(e,i,t[i]);return e},a=(e,o)=>t(e,i(o));import{c as l,r as d,R as h,a as u}from"./vendor.fd81f3b5.js";const p=l();function f(e){const{kingPositions:t,board:i,notKingPiece:o}=e,[n,s]=t;if(n.x!==s.x)return!1;{const e=n.x,t=i.pieces.filter((t=>t.position.x===e)).filter((e=>e.position.y>Math.min(n.y,s.y)&&e.position.y<Math.max(n.y,s.y)));if(t.length>=2)return!1;if(0===t.length)return!0;const r=t[0];return!(!o||r!==(null==o?void 0:o.piece)||o.nextPosition.x===e)}}function b(e,t,i){const o=i.value;i.value=function(...e){let t=o.apply(this,[...e]);return t=t.filter((e=>R.load(e).valid())).map((e=>e instanceof R?e.dump():e)),t.filter((e=>{const[t,i]=this.board.pieces.filter((e=>e.type===y.King));return!t||!i||!f({kingPositions:[t.position,i.position],board:this.board,notKingPiece:{piece:this,nextPosition:e}})}))}}var y,m,g,x;(m=y||(y={})).King="King",m.Advisor="Advisor",m.Bishop="Bishop",m.Knight="Knight",m.Rook="Rook",m.Cannon="Cannon",m.Pawn="Pawn",(x=g||(g={})).Red="Red",x.Black="Black";class P{constructor(){this.minX=1,this.maxX=9,this.minY=1,this.maxY=10}}class R extends P{constructor(e){super(),this.x=e.x,this.y=e.y}static load(e){return new R(e)}clone(){return new R(this.dump())}valid(){const e=this.x>=this.minX&&this.x<=this.maxX,t=this.y>=this.minY&&this.y<=this.maxY;return e&&t}top(e=1){return this.y=this.y-e,this}right(e=1){return this.x=this.x+e,this}bottom(e=1){return this.top(-e),this}left(e=1){return this.right(-e),this}dump(){return{x:this.x,y:this.y}}}class v extends P{constructor(e){super(),this.board=e.board,this.type=e.type,this.side=e.side,this.initPosition=e.initPosition,this.position=e.initPosition}at(e){return this.position.x===e.x&&this.position.y===e.y}nextPositionsContain(e){return this.getNextPositions().some((t=>{return o=e,(i=t).x===o.x&&i.y===o.y;var i,o}))}moveTo(e){if(this.nextPositionsContain(e)){const t=this.board.eatPiece(e);if(this.prevPosition=this.position,this.position=e,p.emit("move",this,t),this.board.end())return;this.board.switch()}else console.log(`[warn] [${this.getName()}] at ${JSON.stringify(this.position)}: next position illegal.`)}dump(){return{type:this.type,side:this.side,position:this.position}}}v.Type=y,v.Side=g;class k extends v{constructor(e){super(a(c({},e),{type:y.Pawn}))}static createRed(e){return new k(a(c({},e),{side:g.Red}))}static createBlack(e){return new k(a(c({},e),{side:g.Black}))}getName(){return this.side===g.Red?"兵":"卒"}getNextPositions(){const e=R.load(this.position);return this.side===g.Black?e.y<=5?[e.clone().bottom()]:[e.clone().bottom(),e.clone().right(),e.clone().left()]:e.y>=6?[e.clone().top()]:[e.clone().top(),e.clone().right(),e.clone().left()]}}!function(e,t,i,o){var n,s=arguments.length,r=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,i,o);else for(var c=e.length-1;c>=0;c--)(n=e[c])&&(r=(s<3?n(r):s>3?n(t,i,r):n(t,i))||r);s>3&&r&&Object.defineProperty(t,i,r)}([b],k.prototype,"getNextPositions",null);class w extends v{constructor(e){super(a(c({},e),{type:y.Cannon}))}static createRed(e){return new w(a(c({},e),{side:g.Red}))}static createBlack(e){return new w(a(c({},e),{side:g.Black}))}getName(){return this.side===g.Red?"炮":"砲"}getNextPositions(){const e=[],t=R.load(this.position),i=[0,0,0,0],o=(e=1)=>[t.clone().top(e),t.clone().right(e),t.clone().bottom(e),t.clone().left(e)];let n=1;for(;;){const t=o(n);if(!t.find((e=>e.valid())))break;t.forEach(((t,o)=>{if(!t.valid())return;const n=this.board.findPiece(t);n||0!==i[o]||e.push(t),n&&(1===i[o]&&n.side!==this.side&&e.push(t),i[o]+=1)})),n+=1}return e}}!function(e,t,i,o){var n,s=arguments.length,r=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,i,o);else for(var c=e.length-1;c>=0;c--)(n=e[c])&&(r=(s<3?n(r):s>3?n(t,i,r):n(t,i))||r);s>3&&r&&Object.defineProperty(t,i,r)}([b],w.prototype,"getNextPositions",null);class E extends v{constructor(e){super(a(c({},e),{type:y.Rook}))}static createRed(e){return new E(a(c({},e),{side:g.Red}))}static createBlack(e){return new E(a(c({},e),{side:g.Black}))}getName(){return this.side===g.Red?"俥":"車"}getNextPositions(){const e=[],t=R.load(this.position),i=[0,0,0,0],o=(e=1)=>[t.clone().top(e),t.clone().right(e),t.clone().bottom(e),t.clone().left(e)];let n=1;for(;;){const t=o(n);if(!t.find((e=>e.valid())))break;t.forEach(((t,o)=>{if(!t.valid())return;const n=this.board.findPiece(t);n||0!==i[o]||e.push(t),n&&(0===i[o]&&n.side!==this.side&&e.push(t),i[o]+=1)})),n+=1}return e}}!function(e,t,i,o){var n,s=arguments.length,r=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,i,o);else for(var c=e.length-1;c>=0;c--)(n=e[c])&&(r=(s<3?n(r):s>3?n(t,i,r):n(t,i))||r);s>3&&r&&Object.defineProperty(t,i,r)}([b],E.prototype,"getNextPositions",null);class B extends v{constructor(e){super(a(c({},e),{type:y.Knight}))}static createRed(e){return new B(a(c({},e),{side:g.Red}))}static createBlack(e){return new B(a(c({},e),{side:g.Black}))}getName(){return this.side===g.Red?"傌":"馬"}getNextPositions(){const e=[],t=R.load(this.position),i={top:t.clone().top(),right:t.clone().right(),bottom:t.clone().bottom(),left:t.clone().left()},o={top:[t.clone().top(2).left(),t.clone().top(2).right()],right:[t.clone().right(2).top(),t.clone().right(2).bottom()],bottom:[t.clone().bottom(2).left(),t.clone().bottom(2).right()],left:[t.clone().left(2).top(),t.clone().left(2).bottom()]};return Object.keys(i).forEach((t=>{this.board.findPiece(i[t])||o[t].forEach((t=>{const i=this.board.findPiece(t);i||e.push(t),i&&i.side!==this.side&&e.push(t)}))})),e}}!function(e,t,i,o){var n,s=arguments.length,r=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,i,o);else for(var c=e.length-1;c>=0;c--)(n=e[c])&&(r=(s<3?n(r):s>3?n(t,i,r):n(t,i))||r);s>3&&r&&Object.defineProperty(t,i,r)}([b],B.prototype,"getNextPositions",null);class O extends v{constructor(e){super(a(c({},e),{type:y.Bishop}))}static createRed(e){return new O(a(c({},e),{side:g.Red}))}static createBlack(e){return new O(a(c({},e),{side:g.Black}))}getName(){return this.side===g.Red?"相":"象"}getNextPositions(){const e=[],t=R.load(this.position),i={topLeft:t.clone().top().left(),topRight:t.clone().top().right(),bottomLeft:t.clone().bottom().left(),bottomRight:t.clone().bottom().right()},o={topLeft:t.clone().top(2).left(2),topRight:t.clone().top(2).right(2),bottomLeft:t.clone().bottom(2).left(2),bottomRight:t.clone().bottom(2).right(2)};return Object.keys(i).forEach((t=>{if(!this.board.findPiece(i[t])){const i=o[t],n=this.board.findPiece(i);n||e.push(i),n&&n.side!==this.side&&e.push(i)}})),e.filter((e=>this.side===g.Red?e.y>=6:e.y<=5))}}!function(e,t,i,o){var n,s=arguments.length,r=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,i,o);else for(var c=e.length-1;c>=0;c--)(n=e[c])&&(r=(s<3?n(r):s>3?n(t,i,r):n(t,i))||r);s>3&&r&&Object.defineProperty(t,i,r)}([b],O.prototype,"getNextPositions",null);class N extends v{constructor(e){super(a(c({},e),{type:y.Advisor}))}static createRed(e){return new N(a(c({},e),{side:g.Red}))}static createBlack(e){return new N(a(c({},e),{side:g.Black}))}getName(){return this.side===g.Red?"仕":"士"}getNextPositions(){const e=[],t=R.load(this.position);return[t.clone().top().left(),t.clone().top().right(),t.clone().bottom().left(),t.clone().bottom().right()].forEach((t=>{const i=this.board.findPiece(t);i||e.push(t),i&&i.side!==this.side&&e.push(t)})),e.filter((e=>e.x>=4&&e.x<=6&&(this.side===g.Red?e.y>=8&&e.y<=10:e.y>=1&&e.y<=3)))}}!function(e,t,i,o){var n,s=arguments.length,r=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,i,o);else for(var c=e.length-1;c>=0;c--)(n=e[c])&&(r=(s<3?n(r):s>3?n(t,i,r):n(t,i))||r);s>3&&r&&Object.defineProperty(t,i,r)}([b],N.prototype,"getNextPositions",null);class j extends v{constructor(e){super(a(c({},e),{type:y.King}))}static createRed(e){return new j(a(c({},e),{side:g.Red}))}static createBlack(e){return new j(a(c({},e),{side:g.Black}))}getName(){return this.side===g.Red?"帥":"將"}getNextPositions(){let e=[];const t=R.load(this.position);[t.clone().top(),t.clone().right(),t.clone().bottom(),t.clone().left()].forEach((t=>{const i=this.board.findPiece(t);i||e.push(t),i&&i.side!==this.side&&e.push(t)})),e=e.filter((e=>e.x>=4&&e.x<=6&&(this.side===g.Red?e.y>=8&&e.y<=10:e.y>=1&&e.y<=3)));const i=this.board.pieces.find((e=>e.type===y.King&&e.side!==this.side));return e.filter((e=>!f({kingPositions:[i.position,e],board:this.board})))}}!function(e,t,i,o){var n,s=arguments.length,r=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,i,o);else for(var c=e.length-1;c>=0;c--)(n=e[c])&&(r=(s<3?n(r):s>3?n(t,i,r):n(t,i))||r);s>3&&r&&Object.defineProperty(t,i,r)}([b],j.prototype,"getNextPositions",null);const C={Pawn:k,Cannon:w,Rook:E,Knight:B,Bishop:O,Advisor:N,King:j};class A extends P{constructor(){super(),this.turn=g.Red,this.positions=this.getPositions(),this.history=[],this.head=-1,this.pieces=[...this.initBlockPieces(),...this.initRedPieces()],p.on("move",((e,t)=>{const i={type:e.type,side:e.side,from:e.prevPosition,to:e.position};t&&(i.eat=t.type),this.head+1<this.history.length&&(this.history=this.history.slice(0,this.head+1)),this.history.push(i),this.head=this.history.length-1}))}initBlockPieces(){return[k.createBlack({initPosition:{x:1,y:4},board:this}),k.createBlack({initPosition:{x:3,y:4},board:this}),k.createBlack({initPosition:{x:5,y:4},board:this}),k.createBlack({initPosition:{x:7,y:4},board:this}),k.createBlack({initPosition:{x:9,y:4},board:this}),w.createBlack({initPosition:{x:2,y:3},board:this}),w.createBlack({initPosition:{x:8,y:3},board:this}),E.createBlack({initPosition:{x:1,y:1},board:this}),E.createBlack({initPosition:{x:9,y:1},board:this}),B.createBlack({initPosition:{x:2,y:1},board:this}),B.createBlack({initPosition:{x:8,y:1},board:this}),O.createBlack({initPosition:{x:3,y:1},board:this}),O.createBlack({initPosition:{x:7,y:1},board:this}),N.createBlack({initPosition:{x:4,y:1},board:this}),N.createBlack({initPosition:{x:6,y:1},board:this}),j.createBlack({initPosition:{x:5,y:1},board:this})]}initRedPieces(){return[k.createRed({initPosition:{x:1,y:7},board:this}),k.createRed({initPosition:{x:3,y:7},board:this}),k.createRed({initPosition:{x:5,y:7},board:this}),k.createRed({initPosition:{x:7,y:7},board:this}),k.createRed({initPosition:{x:9,y:7},board:this}),w.createRed({initPosition:{x:2,y:8},board:this}),w.createRed({initPosition:{x:8,y:8},board:this}),E.createRed({initPosition:{x:1,y:10},board:this}),E.createRed({initPosition:{x:9,y:10},board:this}),B.createRed({initPosition:{x:2,y:10},board:this}),B.createRed({initPosition:{x:8,y:10},board:this}),O.createRed({initPosition:{x:3,y:10},board:this}),O.createRed({initPosition:{x:7,y:10},board:this}),N.createRed({initPosition:{x:4,y:10},board:this}),N.createRed({initPosition:{x:6,y:10},board:this}),j.createRed({initPosition:{x:5,y:10},board:this})]}end(){return this.pieces.filter((e=>e.type===y.King)).length<2}reset(){this.pieces=[...this.initBlockPieces(),...this.initRedPieces()],this.turn=g.Red,p.emit("reset",this)}canUndo(){return this.history.length>0&&this.head>=0}undo(){if(this.canUndo()){const e=this.history[this.head],t=this.findPiece(e.to);t.position=e.from,t.prevPosition=void 0,e.eat&&this.createPiece({type:e.eat,side:e.side===g.Black?g.Red:g.Black,initPosition:e.to}),this.head-=1,p.emit("undo",e)}else console.warn("cannot undo!")}canRedo(){return this.head+1!==this.history.length}redo(){if(this.canRedo()){const e=this.history[this.head+1],t=this.findPiece(e.from);t.position=e.to,t.prevPosition=e.from,e.eat&&this.eatPiece(e.to),this.head+=1,p.emit("undo",e)}else console.warn("cannot redo!")}getPositions(){const e=[];let t=1;do{let i=1;do{e.push({x:i,y:t}),i+=1}while(i<=this.maxX);t+=1}while(t<=this.maxY);return e}findPiece(e){return this.pieces.find((t=>t.at(e)))}switch(){this.turn=this.turn===g.Red?g.Black:g.Red,p.emit("switch",this.turn)}eatPiece(e){const t=e instanceof v?e:this.findPiece(e);if(t&&t.side!==this.turn)return this.pieces=this.pieces.filter((e=>e!==t)),p.emit("eat",t),t}dump(){return{turn:this.turn,pieces:this.pieces.map((e=>e.dump()))}}createPiece(e){return new(0,C[e.type])({board:this,side:e.side,initPosition:e.initPosition})}static load(e){const t=new A;return t.turn=e.turn,t.pieces=e.pieces.map((e=>t.createPiece({type:e.type,side:e.side,initPosition:e.position}))),t}}class K{constructor(){this.board=new A}on(e,t){return p.on(e,t)}}function I(){const e=d.exports.useRef(),[,t]=d.exports.useState({}),i=()=>{t({})};return null==e.current&&(e.current=(e=>{const t=new K;return t.on("move",(()=>{e()})),t.on("reset",(()=>{e()})),t.on("undo",(()=>{e()})),t.on("redo",(()=>{e()})),t})(i)),e.current}function S(e){return Math.floor(Math.random()*e)}function $(e){const t=[],i=function(e){return e instanceof A?e:A.load(e)}(e),o=()=>{const e=i.pieces.filter((e=>e.side===i.turn)).filter((e=>!t.includes(e)));if(!e.length)return null;const n=e[S(e.length)];return n.getNextPositions().length?n:(t.push(n),o())},n=o();if(!n)return null;const s=n.getNextPositions(),r=s[S(s.length)];return{current:n.position,next:r}}const D=e=>{const{position:t,type:i="placeholder",selected:o,next:n,moved:s,onClick:r,children:c}=e,a="piece"===i;return h.createElement("div",{style:{position:"absolute",top:48*(t.y-1)-20,left:48*(t.x-1)-20,width:40,height:40,borderRadius:"50%",background:n?"#ffef99":a?"gold":"unset",boxShadow:s?"rgba(0, 0, 0, 0.24) 0px 3px 8px":"unset",display:"flex",justifyContent:"center",alignItems:"center",cursor:"pointer"},className:a&&o?"piece-selected":"",onClick:()=>{null==r||r(t)}},c)},M=e=>{const{board:t,actionRef:i}=e,[o,n]=h.useState(),[s,r]=h.useState(),a=t.maxX-t.minX+1,l=t.maxY-t.minY+1,d=e=>{const i=t.findPiece(e);if(o!==i){if(!(t.pieces.filter((e=>e.type===y.King)).length<2))return(null==o?void 0:o.nextPositionsContain(e))?(o.moveTo(e),r(o),void n(void 0)):void(i&&i.side===t.turn&&n(i))}else n(void 0)};return h.useImperativeHandle(i,(()=>({click:d}))),h.createElement("div",{style:{display:"inline-block",padding:72}},h.createElement("div",null,new Array(l-1).fill(!0).map(((e,t)=>{const i={width:48*(a-1),height:47,borderBottom:"1px solid black"};return h.createElement("div",{key:`horizontal-line-${t+1}`,style:c(c({},i),0===t?{borderTop:"1px solid black"}:{})})}))),h.createElement("div",{style:{position:"relative",top:48*-(l-1)}},new Array(a).fill(!0).map(((e,t)=>0===t||t+1===a?h.createElement("div",{key:`vertical-line-${t+1}`,style:{position:"absolute",top:0,left:48*t,height:48*(l-1),borderRight:"1px solid black"}}):h.createElement(h.Fragment,{key:`vertical-line-${t+1}`},h.createElement("div",{style:{position:"absolute",top:0,left:48*t,height:48*(l/2-1),borderRight:"1px solid black"}}),h.createElement("div",{style:{position:"absolute",top:240,left:48*t,height:48*(l/2-1),borderRight:"1px solid black"}})))),t.positions.map((e=>{const i=t.findPiece(e);return h.createElement(D,{key:`${JSON.stringify(e)}`,position:e,type:i?"piece":"placeholder",next:o&&(null==o?void 0:o.nextPositionsContain(e)),moved:s&&i===s,selected:i===o,onClick:d},i&&h.createElement("span",{style:{color:i.side.toLowerCase()}},i.getName()))}))))};var T,X;(X=T||(T={}))[X.Player=0]="Player",X[X.RandomAI=1]="RandomAI",X[X.MinimaxAI=2]="MinimaxAI",X[X.AlphaBetaAI=3]="AlphaBetaAI";const Y=[{value:0,label:"玩家"},{value:1,label:"AI (random)"},{value:2,label:"AI (minimax)",disabled:!0},{value:3,label:"AI (alpha–beta)",disabled:!0}];function L(e,t){const{index:i=0,onEnd:o}=t||{};e[i](),i+1<e.length&&setTimeout((()=>{L(e,{index:i+1,onEnd:o})}),800),i+1===e.length&&(null==o||o())}var J=()=>{const e=I(),t=d.exports.useRef(),[i,o]=d.exports.useState(!1),[n,s]=d.exports.useState(0),[r,c]=d.exports.useState(1),a=()=>{var i;const n=$(e.board);n?(console.log(`move: ${null==(i=e.board.findPiece(n.current))?void 0:i.getName()} ${JSON.stringify(n.current)} => ${JSON.stringify(n.next)}`),o(!0),L([()=>{var e;return null==(e=t.current)?void 0:e.click(n.current)},()=>{var e;return null==(e=t.current)?void 0:e.click(n.next)}],{onEnd:()=>o(!1)})):alert((e.board.turn===g.Red?"红方":"黑方")+" 认输！")},l=e=>{setTimeout((()=>{if(e===g.Red)switch(n){case 1:return void a();default:return}else switch(r){case 1:return void a();default:return}}))};d.exports.useEffect((()=>{const t=e.on("switch",l);return()=>t()}),[n,r]),d.exports.useEffect((()=>{e.board.end()||l(e.board.turn)}),[n,r]);return h.createElement("div",{style:{textAlign:"center"}},h.createElement("div",{style:{marginTop:24}},h.createElement("span",null,(()=>{const t=e.board.pieces.some((e=>e.type===y.King&&e.side===g.Black))?e.board.pieces.some((e=>e.type===y.King&&e.side===g.Red))?null:g.Black:g.Red;return t?(t===g.Red?"红方":"黑方")+"获胜!":(e.board.turn===g.Red?"红方":"黑方")+"着手"})())),h.createElement("div",null,h.createElement("span",null,i?"running...":"idle...")),h.createElement(M,{board:e.board,actionRef:t}),h.createElement("div",null,h.createElement("label",null,"红方")," ",h.createElement("select",{value:n,onChange:e=>s(Number(e.target.value))},Y.map((e=>h.createElement("option",{key:e.value,value:e.value,disabled:e.disabled},e.label)))),"  ",h.createElement("label",null,"黑方")," ",h.createElement("select",{value:r,onChange:e=>c(Number(e.target.value))},Y.map((e=>h.createElement("option",{key:e.value,value:e.value,disabled:e.disabled},e.label))))),h.createElement("hr",null),h.createElement("div",null,h.createElement("label",null,"Next move by AI:")," ",h.createElement("button",{disabled:i,onClick:a},"random")," ",h.createElement("button",{disabled:!0,onClick:a},"minimax (coming soon)")," ",h.createElement("button",{disabled:!0,onClick:a},"alpha–beta (coming soon)")),h.createElement("hr",null),h.createElement("div",null,h.createElement("button",{onClick:()=>e.board.reset(),disabled:i},"重新开始")," ",h.createElement("button",{disabled:!e.board.canUndo(),onClick:()=>e.board.undo()},"Undo")," ",h.createElement("button",{disabled:!e.board.canRedo(),onClick:()=>e.board.redo()},"Redo")))};u.render(h.createElement(h.StrictMode,null,h.createElement(J,null)),document.getElementById("root"));
